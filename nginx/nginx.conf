# =============================================================
# Nginx Configuration for Production Environment
# =============================================================

# =============================================================
# Events Block: Configures worker processes and connections
# =============================================================
events {
    # Maximum number of simultaneous connections that can be opened by a worker process
    worker_connections 1024;
}

# =============================================================
# HTTP Block: Main configuration for handling HTTP/HTTPS traffic
# =============================================================
http {
    # Disable server tokens to prevent revealing Nginx version information
    server_tokens off;

    # Set the default character encoding
    charset utf-8;

    # =============================================================
    # HTTP Server: Redirects all HTTP traffic to HTTPS (Port 4000 -> 4443)
    # =============================================================
    server {
        # Listen on port 4000 for HTTP traffic
        listen 4000;

        # Define the server name (your subdomain)
        server_name modules.ewubd.edu;

        # =============================================================
        # Location Block: Redirect all traffic to HTTPS on port 4443
        # =============================================================
        location / {
            # Permanent redirect to HTTPS (Port 4443)
            return 301 https://$host:4443$request_uri;
        }
    }

    # =============================================================
    # HTTPS Server: Handles secure traffic on port 4443
    # =============================================================
    server {
        # Listen on port 4443 for HTTPS traffic
        listen 4443 ssl;

        # Define the server name (your subdomain)
        server_name modules.ewubd.edu;

        # =============================================================
        # SSL Configuration: Specifies SSL certificate and key
        # =============================================================
        ssl_certificate /etc/nginx/ssl/fullchain.pem;      # Full Chain Certificate (including intermediate cert)
        ssl_certificate_key /etc/nginx/ssl/key2024.key;     # SSL Private Key

        # =============================================================
        # SSL Protocols and Ciphers: Define supported protocols and ciphers
        # =============================================================
        ssl_protocols TLSv1.2 TLSv1.3;                      # Only use strong protocols
        ssl_prefer_server_ciphers on;                        # Prefer server ciphers over client ciphers
        ssl_ciphers "HIGH:!aNULL:!MD5";                      # Define acceptable ciphers

        # =============================================================
        # Proxy Settings: Forward requests to the Python server
        # =============================================================
        location /courseFiles/processFiles/ {
            # Forward requests to the Python server running on port 3005
            proxy_pass http://python_server:3005/;           # 'python_server' is the service name in docker-compose.yml

            # Set headers to preserve client information
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        # =============================================================
        # Proxy Settings: Forward requests to the MinIO server
        # =============================================================
        location /courseFiles/storage/ {
            # Forward requests to the MinIO server running on port 9000
            proxy_pass http://minio:9000/;                   # 'minio' is the service name in docker-compose.yml

            # Set headers to preserve client information
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        # =============================================================
        # Proxy Settings: Forward all other requests to the Next.js app
        # =============================================================
        location /courseFiles/ {
            # Forward all other requests under /courseFiles/ to the Next.js app running on port 3000
            proxy_pass http://app:3000/;                      # 'app' is the service name in docker-compose.yml

            # Set headers to preserve client information
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        # =============================================================
        # Static Files Serving: Optionally serve static files directly
        # =============================================================
        location /static/ {
            # Define the directory path to serve static files
            alias /path/to/static/files/;                     # Update this path to your actual static files location

            # Optional: Improve performance by enabling caching
            expires 30d;                                      # Cache static files for 30 days
            add_header Cache-Control "public, no-transform";
        }

        # =============================================================
        # Custom Error Pages for handling different HTTP errors
        # =============================================================
        error_page 404 /404.html;
        location = /404.html {
            root /usr/share/nginx/html;  # Location for custom 404 page
            internal;                    # Ensure this location is not accessible directly
        }

        error_page 500 502 503 504 /50x.html;
        location = /50x.html {
            root /usr/share/nginx/html;  # Location for custom 50x page (server errors)
            internal;                    # Ensure this location is not accessible directly
        }
    }
}
